{"version":3,"sources":["webpack://shared-reducer-backend/webpack/universalModuleDefinition","webpack://shared-reducer-backend/webpack/bootstrap","webpack://shared-reducer-backend/external \"crypto\"","webpack://shared-reducer-backend/external \"events\"","webpack://shared-reducer-backend/./src/helpers/UniqueIdProvider.ts","webpack://shared-reducer-backend/./src/task-queue/AsyncTaskQueue.ts","webpack://shared-reducer-backend/./src/task-queue/TaskQueueMap.ts","webpack://shared-reducer-backend/./src/topic/TrackingTopicMap.ts","webpack://shared-reducer-backend/./src/topic/InMemoryTopic.ts","webpack://shared-reducer-backend/./src/permission/ReadWrite.ts","webpack://shared-reducer-backend/./src/Broadcaster.ts","webpack://shared-reducer-backend/./src/handlers/Message.ts","webpack://shared-reducer-backend/./src/handlers/websocketHandler.ts","webpack://shared-reducer-backend/./src/model/CollectionStorageModel.ts","webpack://shared-reducer-backend/./src/permission/Permission.ts","webpack://shared-reducer-backend/./src/model/InMemoryModel.ts","webpack://shared-reducer-backend/./src/permission/ReadOnly.ts","webpack://shared-reducer-backend/./src/permission/ReadWriteStruct.ts"],"names":["root","factory","exports","module","define","amd","global","installedModules","__webpack_require__","moduleId","i","l","modules","call","m","c","d","name","getter","o","Object","defineProperty","enumerable","get","r","Symbol","toStringTag","value","t","mode","__esModule","ns","create","key","bind","n","object","property","prototype","hasOwnProperty","p","s","require","UniqueIdProvider","crypto","randomBytes","toString","id","this","unique","shared","AsyncTaskQueue","EventEmitter","push","task","Promise","resolve","reject","queue","running","internalConsumeQueue","length","shift","result","success","e","emit","TaskQueueMap","constructor","queueFactory","Map","queues","on","delete","set","TrackingTopicMap","topicFactory","fn","data","add","remove","message","broadcast","InMemoryTopic","Set","subscribers","size","forEach","sub","ReadWrite","validateWrite","Broadcaster","model","context","taskQueues","idProvider","bContext","bSubscribers","bTaskQueues","bIdProvider","builder","withReducer","withSubscribers","withTaskQueues","withIdProvider","build","Error","onChange","permission","initialData","read","myId","eventHandler","source","meta","change","undefined","getInitialData","send","internalQueueChange","close","async","update","original","validateWriteSpec","updated","validatedUpdate","validate","write","error","internalApplyChange","isObject","Array","isArray","unpackMessage","msg","rawData","validateMessage","JSON","parse","PING","PONG","websocketHandler","broadcaster","idGetter","permissionGetter","req","res","ws","accept","subscription","subscribe","stringify","isBinary","String","request","beginTransaction","finally","endTransaction","init","sendError","ERROR_NOP","CollectionStorageModel","collection","idCol","validator","readErrorIntercept","writeErrorIntercept","newValue","oldValue","diff","entries","k","configurable","writable","PermissionError","InMemoryModel","x","memory","ReadOnly","ReadWriteStruct","readOnlyFields","keys","includes"],"mappings":"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","file":"index.js","sourcesContent":["(function webpackUniversalModuleDefinition(root, factory) {\n\tif(typeof exports === 'object' && typeof module === 'object')\n\t\tmodule.exports = factory();\n\telse if(typeof define === 'function' && define.amd)\n\t\tdefine(\"shared-reducer-backend\", [], factory);\n\telse if(typeof exports === 'object')\n\t\texports[\"shared-reducer-backend\"] = factory();\n\telse\n\t\troot[\"shared-reducer-backend\"] = factory();\n})(global, function() {\nreturn "," \t// The module cache\n \tvar installedModules = {};\n\n \t// The require function\n \tfunction __webpack_require__(moduleId) {\n\n \t\t// Check if module is in cache\n \t\tif(installedModules[moduleId]) {\n \t\t\treturn installedModules[moduleId].exports;\n \t\t}\n \t\t// Create a new module (and put it into the cache)\n \t\tvar module = installedModules[moduleId] = {\n \t\t\ti: moduleId,\n \t\t\tl: false,\n \t\t\texports: {}\n \t\t};\n\n \t\t// Execute the module function\n \t\tmodules[moduleId].call(module.exports, module, module.exports, __webpack_require__);\n\n \t\t// Flag the module as loaded\n \t\tmodule.l = true;\n\n \t\t// Return the exports of the module\n \t\treturn module.exports;\n \t}\n\n\n \t// expose the modules object (__webpack_modules__)\n \t__webpack_require__.m = modules;\n\n \t// expose the module cache\n \t__webpack_require__.c = installedModules;\n\n \t// define getter function for harmony exports\n \t__webpack_require__.d = function(exports, name, getter) {\n \t\tif(!__webpack_require__.o(exports, name)) {\n \t\t\tObject.defineProperty(exports, name, { enumerable: true, get: getter });\n \t\t}\n \t};\n\n \t// define __esModule on exports\n \t__webpack_require__.r = function(exports) {\n \t\tif(typeof Symbol !== 'undefined' && Symbol.toStringTag) {\n \t\t\tObject.defineProperty(exports, Symbol.toStringTag, { value: 'Module' });\n \t\t}\n \t\tObject.defineProperty(exports, '__esModule', { value: true });\n \t};\n\n \t// create a fake namespace object\n \t// mode & 1: value is a module id, require it\n \t// mode & 2: merge all properties of value into the ns\n \t// mode & 4: return value when already ns object\n \t// mode & 8|1: behave like require\n \t__webpack_require__.t = function(value, mode) {\n \t\tif(mode & 1) value = __webpack_require__(value);\n \t\tif(mode & 8) return value;\n \t\tif((mode & 4) && typeof value === 'object' && value && value.__esModule) return value;\n \t\tvar ns = Object.create(null);\n \t\t__webpack_require__.r(ns);\n \t\tObject.defineProperty(ns, 'default', { enumerable: true, value: value });\n \t\tif(mode & 2 && typeof value != 'string') for(var key in value) __webpack_require__.d(ns, key, function(key) { return value[key]; }.bind(null, key));\n \t\treturn ns;\n \t};\n\n \t// getDefaultExport function for compatibility with non-harmony modules\n \t__webpack_require__.n = function(module) {\n \t\tvar getter = module && module.__esModule ?\n \t\t\tfunction getDefault() { return module['default']; } :\n \t\t\tfunction getModuleExports() { return module; };\n \t\t__webpack_require__.d(getter, 'a', getter);\n \t\treturn getter;\n \t};\n\n \t// Object.prototype.hasOwnProperty.call\n \t__webpack_require__.o = function(object, property) { return Object.prototype.hasOwnProperty.call(object, property); };\n\n \t// __webpack_public_path__\n \t__webpack_require__.p = \"\";\n\n\n \t// Load entry module and return exports\n \treturn __webpack_require__(__webpack_require__.s = 2);\n","module.exports = require(\"crypto\");","module.exports = require(\"events\");","import crypto from 'crypto';\n\nexport default class UniqueIdProvider {\n  private shared = crypto.randomBytes(8).toString('hex');\n\n  private unique = 0;\n\n  public get(): string {\n    const id = this.unique;\n    this.unique += 1;\n    return `${this.shared}-${id}`;\n  }\n}\n","import { EventEmitter } from 'events';\nimport type { Task, TaskQueue } from './TaskQueue';\n\ninterface QueueItem<T> {\n  task: Task<T>;\n  resolve: (v: T) => void;\n  reject: (e: Error) => void;\n}\n\nexport default class AsyncTaskQueue<T> extends EventEmitter implements TaskQueue<T> {\n  private queue: QueueItem<T>[] = [];\n\n  private running = false;\n\n  public push(task: Task<T>): Promise<T> {\n    return new Promise<T>((resolve, reject): void => {\n      this.queue.push({ task, resolve, reject });\n      if (!this.running) {\n        this.internalConsumeQueue();\n      }\n    });\n  }\n\n  private async internalConsumeQueue(): Promise<void> {\n    this.running = true;\n    while (this.queue.length > 0) {\n      const { task, resolve, reject } = this.queue.shift()!;\n\n      let result = null;\n      let success = false;\n      try {\n        /* eslint-disable-next-line no-await-in-loop */ // intentionally serial\n        result = await task();\n        success = true;\n      } catch (e: unknown) {\n        reject(e as Error);\n      }\n      if (success) {\n        resolve(result!);\n      }\n    }\n    this.running = false;\n    this.emit('drain');\n  }\n}\n","import AsyncTaskQueue from './AsyncTaskQueue';\nimport type { TaskQueue, Task } from './TaskQueue';\n\nexport default class TaskQueueMap<T> {\n  private readonly queues = new Map<string, TaskQueue<T>>();\n\n  public constructor(\n    private readonly queueFactory = (): TaskQueue<T> => new AsyncTaskQueue<T>(),\n  ) {}\n\n  public push(key: string, task: Task<T>): Promise<T> {\n    let queue = this.queues.get(key);\n    if (!queue) {\n      queue = this.queueFactory();\n      queue.on('drain', () => {\n        this.queues.delete(key);\n      });\n      this.queues.set(key, queue);\n    }\n    return queue.push(task);\n  }\n}\n","import type TopicMap from './TopicMap';\nimport type { Topic, TopicListener } from './Topic';\n\nexport default class TrackingTopicMap<T> implements TopicMap<T> {\n  private data = new Map<string, Topic<T>>();\n\n  public constructor(\n    private readonly topicFactory: (key: string) => Topic<T>,\n  ) {}\n\n  public async add(key: string, fn: TopicListener<T>): Promise<void> {\n    let d = this.data.get(key);\n    if (!d) {\n      d = this.topicFactory(key);\n      this.data.set(key, d);\n    }\n    await d.add(fn);\n  }\n\n  public async remove(key: string, fn: TopicListener<T>): Promise<void> {\n    const d = this.data.get(key);\n    if (d) {\n      const anyRemaining = await d.remove(fn);\n      if (!anyRemaining) {\n        this.data.delete(key);\n      }\n    }\n  }\n\n  public async broadcast(key: string, message: T): Promise<void> {\n    const d = this.data.get(key);\n    if (d) {\n      await d.broadcast(message);\n    }\n  }\n}\n","import type { Topic, TopicListener } from './Topic';\n\nexport default class InMemoryTopic<T> implements Topic<T> {\n  private subscribers = new Set<TopicListener<T>>();\n\n  public add(fn: TopicListener<T>): void {\n    this.subscribers.add(fn);\n  }\n\n  public remove(fn: TopicListener<T>): boolean {\n    this.subscribers.delete(fn);\n    return this.subscribers.size > 0;\n  }\n\n  public broadcast(message: T): void {\n    this.subscribers.forEach((sub) => sub(message));\n  }\n}\n","import type Permission from './Permission';\n\nconst ReadWrite: Permission<unknown, unknown> = {\n  validateWrite(): void {\n    // nothing to do\n  },\n};\n\nexport default ReadWrite;\n","import UniqueIdProvider from './helpers/UniqueIdProvider';\nimport TaskQueueMap from './task-queue/TaskQueueMap';\nimport type TopicMap from './topic/TopicMap';\nimport TrackingTopicMap from './topic/TrackingTopicMap';\nimport InMemoryTopic from './topic/InMemoryTopic';\nimport type Permission from './permission/Permission';\nimport ReadWrite from './permission/ReadWrite';\nimport type Model from './model/Model';\n\nexport interface Context<T, SpecT> {\n  update: (input: T, spec: SpecT) => T;\n}\n\nexport interface Subscription<T, SpecT, MetaT> {\n  getInitialData: () => Readonly<T>;\n  send: (change: SpecT, meta?: MetaT) => Promise<void>;\n  close: () => Promise<void>;\n}\n\ntype Identifier = string | null;\n\nexport type ChangeInfo<SpecT> = {\n  change: SpecT;\n  error?: undefined;\n} | {\n  change?: undefined;\n  error: string;\n};\n\nexport interface TopicMessage<SpecT> {\n  message: ChangeInfo<SpecT>;\n  source: Identifier;\n  meta?: unknown;\n}\n\ninterface BroadcasterBuilder<T, SpecT> {\n  withReducer<SpecT2 extends SpecT>(\n    context: Context<T, SpecT2>,\n  ): BroadcasterBuilder<T, SpecT2>;\n\n  withSubscribers(subscribers: TopicMap<TopicMessage<SpecT>>): this;\n\n  withTaskQueues(taskQueues: TaskQueueMap<void>): this;\n\n  withIdProvider(idProvider: UniqueIdProvider): this;\n\n  build(): Broadcaster<T, SpecT>;\n}\n\nexport class Broadcaster<T, SpecT> {\n  private constructor(\n    private readonly model: Model<T>,\n    private readonly context: Context<T, SpecT>,\n    private readonly subscribers: TopicMap<TopicMessage<SpecT>>,\n    private readonly taskQueues: TaskQueueMap<void>,\n    private readonly idProvider: UniqueIdProvider,\n  ) {}\n\n  public static for<T2>(model: Model<T2>): BroadcasterBuilder<T2, unknown> {\n    let bContext: Context<T2, unknown>;\n    let bSubscribers: TopicMap<TopicMessage<unknown>>;\n    let bTaskQueues: TaskQueueMap<void>;\n    let bIdProvider: UniqueIdProvider;\n\n    // return types are defined in BroadcasterBuilder interface */\n    /* eslint-disable @typescript-eslint/explicit-function-return-type */\n    const builder = {\n      withReducer(context: Context<T2, unknown>) {\n        bContext = context;\n        return builder;\n      },\n\n      withSubscribers(subscribers: TopicMap<TopicMessage<unknown>>) {\n        bSubscribers = subscribers;\n        return builder;\n      },\n\n      withTaskQueues(taskQueues: TaskQueueMap<void>) {\n        bTaskQueues = taskQueues;\n        return builder;\n      },\n\n      withIdProvider(idProvider: UniqueIdProvider) {\n        bIdProvider = idProvider;\n        return builder;\n      },\n\n      build() {\n        if (!bContext) {\n          throw new Error('must set broadcaster context');\n        }\n        return new Broadcaster(\n          model,\n          bContext,\n          bSubscribers || new TrackingTopicMap(() => new InMemoryTopic()),\n          bTaskQueues || new TaskQueueMap<void>(),\n          bIdProvider || new UniqueIdProvider(),\n        );\n      },\n    };\n    /* eslint-enable @typescript-eslint/explicit-function-return-type */\n    return builder as BroadcasterBuilder<T2, unknown>;\n  }\n\n  public async subscribe<MetaT>(\n    id: string,\n    onChange: (message: ChangeInfo<SpecT>, meta: MetaT | undefined) => void,\n    permission: Permission<T, SpecT> = ReadWrite,\n  ): Promise<Subscription<T, SpecT, MetaT> | null> {\n    let initialData = await this.model.read(id);\n    if (initialData === null || initialData === undefined) {\n      return null;\n    }\n\n    const myId = this.idProvider.get();\n    const eventHandler = ({ message, source, meta }: TopicMessage<SpecT>): void => {\n      if (source === myId) {\n        onChange(message, meta as MetaT);\n      } else if (message.change) {\n        onChange(message, undefined);\n      }\n    };\n\n    this.subscribers.add(id, eventHandler);\n\n    return {\n      getInitialData: (): Readonly<T> => {\n        if (initialData === null) {\n          throw new Error('Already fetched initialData');\n        }\n        const data = initialData!;\n        initialData = null; // GC\n        return data;\n      },\n      send: (\n        change: SpecT,\n        meta?: MetaT,\n      ): Promise<void> => this.internalQueueChange(id, change, permission, myId, meta),\n      close: async (): Promise<void> => {\n        await this.subscribers.remove(id, eventHandler);\n      },\n    };\n  }\n\n  public update(\n    id: string,\n    change: SpecT,\n    permission: Permission<T, SpecT> = ReadWrite,\n  ): Promise<void> {\n    return this.internalQueueChange(id, change, permission, null, undefined);\n  }\n\n  private async internalApplyChange(\n    id: string,\n    change: SpecT,\n    permission: Permission<T, SpecT>,\n    source: Identifier,\n    meta: unknown,\n  ): Promise<void> {\n    try {\n      const original = await this.model.read(id);\n      if (!original) {\n        throw new Error('Deleted');\n      }\n      permission.validateWriteSpec?.(change);\n      const updated = this.context.update(original, change);\n      const validatedUpdate = this.model.validate(updated);\n      permission.validateWrite(validatedUpdate, original);\n\n      await this.model.write(id, validatedUpdate, original);\n    } catch (e: unknown) {\n      this.subscribers.broadcast(id, {\n        message: { error: (e instanceof Error) ? e.message : 'Internal error' },\n        source,\n        meta,\n      });\n      return;\n    }\n\n    this.subscribers.broadcast(id, {\n      message: { change },\n      source,\n      meta,\n    });\n  }\n\n  private async internalQueueChange(\n    id: string,\n    change: SpecT,\n    permission: Permission<T, SpecT>,\n    source: Identifier,\n    meta: unknown,\n  ): Promise<void> {\n    return this.taskQueues.push(\n      id,\n      () => this.internalApplyChange(id, change, permission, source, meta),\n    );\n  }\n}\n","export default interface Message {\n  change: Record<string, unknown>;\n  id?: number;\n}\n\nfunction isObject(o: unknown): o is Record<string, unknown> {\n  return typeof o === 'object' && o !== null && !Array.isArray(o);\n}\n\nexport function validateMessage(rawData: unknown): Message {\n  if (!isObject(rawData)) {\n    throw new Error('Must specify change and optional id');\n  }\n  const { id, change } = rawData;\n  if (!isObject(change)) {\n    throw new Error('change must be a dictionary');\n  }\n  if (id !== undefined && typeof id !== 'number') {\n    throw new Error('if specified, id must be a number');\n  }\n  return { change, id };\n}\n\nexport function unpackMessage(msg: string): Message {\n  // return json.parse(msg, json.object({\n  //   change: json.record,\n  //   id: json.optional(json.number),\n  // }));\n\n  return validateMessage(JSON.parse(msg));\n}\n","import type { Request } from 'express';\nimport type { WSRequestHandler, WSResponse } from 'websocket-express';\nimport { unpackMessage } from './Message';\nimport type { Broadcaster, ChangeInfo } from '../Broadcaster';\nimport type Permission from '../permission/Permission';\n\ninterface ParamsDictionary { [key: string]: string }\ntype ParamsArray = string[];\ntype Params = ParamsDictionary | ParamsArray;\n\nexport const PING = 'P';\nexport const PONG = 'p';\n\ntype DataExtractor<T, P extends Params = ParamsDictionary> = (\n  req: Request<P>,\n  res: WSResponse,\n) => Promise<T> | T;\n\nconst websocketHandler = <T, SpecT>(\n  broadcaster: Broadcaster<T, SpecT>,\n) => <P extends Params = ParamsDictionary>(\n  idGetter: DataExtractor<string, P>,\n  permissionGetter: DataExtractor<Permission<T, SpecT>, P>,\n): WSRequestHandler<P> => async (req, res): Promise<void> => {\n  const ws = await res.accept();\n\n  const onChange = (msg: ChangeInfo<SpecT>, id?: number): void => {\n    const data = (id !== undefined) ? { id, ...msg } : msg;\n    ws.send(JSON.stringify(data));\n  };\n\n  const id = await idGetter(req, res);\n  const permission = await permissionGetter(req, res);\n  const subscription = await broadcaster.subscribe(id, onChange, permission);\n\n  if (!subscription) {\n    res.sendError(404);\n    return;\n  }\n\n  ws.on('close', subscription.close);\n\n  ws.on('message', (data: string | Buffer, isBinary?: boolean) => {\n    if (isBinary) {\n      return; // ignore\n    }\n\n    const msg = String(data);\n    if (msg === PING) {\n      ws.send(PONG);\n      return;\n    }\n\n    const request = unpackMessage(msg);\n\n    res.beginTransaction();\n    subscription.send(request.change as SpecT, request.id)\n      .finally(() => res.endTransaction());\n  });\n\n  ws.send(JSON.stringify({\n    init: subscription.getInitialData(),\n  }));\n};\n\nexport default websocketHandler;\n","import type Model from './Model';\n\n// type matches collection-storage\ninterface Collection<T> {\n  get<K extends keyof T & string>(\n    searchAttribute: K,\n    searchValue: T[K],\n  ): Promise<Readonly<T> | null>;\n\n  update<K extends keyof T & string>(\n    searchAttribute: K,\n    searchValue: T[K],\n    update: Partial<T>,\n  ): Promise<void>;\n}\n\nconst ERROR_NOP = (e: Error): Error => e;\n\nexport default class CollectionStorageModel<T> implements Model<T> {\n  public readonly validate: (v: unknown) => T;\n\n  constructor(\n    private readonly collection: Collection<T>,\n    private readonly idCol: keyof T & string,\n    validator: (v: unknown) => T,\n    private readonly readErrorIntercept = ERROR_NOP,\n    private readonly writeErrorIntercept = ERROR_NOP,\n  ) {\n    this.validate = validator;\n  }\n\n  public async read(id: string): Promise<Readonly<T> | null> {\n    try {\n      // eslint-disable-next-line @typescript-eslint/no-explicit-any\n      return await this.collection.get(this.idCol, id as any);\n    } catch (e: unknown) {\n      throw this.readErrorIntercept(e as Error);\n    }\n  }\n\n  public async write(id: string, newValue: T, oldValue: T): Promise<void> {\n    const diff: Partial<T> = {};\n    Object.entries(newValue).forEach(([k, value]) => {\n      const key = k as keyof T & string;\n      const old = Object.prototype.hasOwnProperty.call(oldValue, key) ? oldValue[key] : undefined;\n      if (value !== old) {\n        if (diff[key]) {\n          Object.defineProperty(diff, key, {\n            value,\n            configurable: true,\n            enumerable: true,\n            writable: true,\n          });\n        } else {\n          diff[key] = value;\n        }\n      }\n    });\n\n    try {\n      // eslint-disable-next-line @typescript-eslint/no-explicit-any\n      await this.collection.update(this.idCol, id as any, diff);\n    } catch (e: unknown) {\n      throw this.writeErrorIntercept(e as Error);\n    }\n  }\n}\n","export class PermissionError extends Error {\n}\n\nexport default interface Permission<T, SpecT> {\n  validateWriteSpec?(spec: SpecT): void;\n\n  validateWrite(newValue: T, oldValue: T): void;\n}\n","import type Model from './Model';\n\nexport default class InMemoryModel<T> implements Model<T> {\n  /* eslint-disable-next-line @typescript-eslint/unbound-method */\n  public readonly read = this.get;\n\n  public readonly validate: (v: unknown) => T;\n\n  private readonly memory = new Map<string, T>();\n\n  constructor(validator = (x: unknown): T => (x as T)) {\n    this.validate = validator;\n  }\n\n  public set(id: string, value: T): void {\n    this.memory.set(id, value);\n  }\n\n  public get(id: string): Readonly<T> | undefined {\n    return this.memory.get(id);\n  }\n\n  public delete(id: string): void {\n    this.memory.delete(id);\n  }\n\n  public write(id: string, newValue: T, oldValue: T): void {\n    const old = this.memory.get(id);\n    if (oldValue !== old) {\n      throw new Error('Unexpected previous value');\n    }\n    this.memory.set(id, newValue);\n  }\n}\n","import Permission, { PermissionError } from './Permission';\n\nexport const READ_ONLY_ERROR = 'Cannot modify data';\n\nconst ReadOnly: Permission<unknown, unknown> = {\n  validateWriteSpec(): void {\n    throw new PermissionError(READ_ONLY_ERROR);\n  },\n\n  validateWrite(): void {\n    throw new PermissionError(READ_ONLY_ERROR);\n  },\n};\n\nexport default ReadOnly;\n","import Permission, { PermissionError } from './Permission';\n\nexport default class ReadWriteStruct<T> implements Permission<T, unknown> {\n  constructor(\n    private readonly readOnlyFields: (keyof T)[] = [],\n  ) {}\n\n  public validateWrite(newValue: T, oldValue: T): void {\n    Object.keys(oldValue).forEach((k) => {\n      const key = k as keyof T & string;\n\n      if (!Object.prototype.hasOwnProperty.call(newValue, key)) {\n        if (this.readOnlyFields.includes(key)) {\n          throw new PermissionError(`Cannot remove field ${key}`);\n        }\n      }\n    });\n\n    Object.keys(newValue).forEach((k) => {\n      const key = k as keyof T & string;\n\n      if (this.readOnlyFields.includes(key)) {\n        if (!Object.prototype.hasOwnProperty.call(oldValue, key)) {\n          throw new PermissionError(`Cannot add field ${key}`);\n        }\n        if (newValue[key] !== oldValue[key]) {\n          throw new PermissionError(`Cannot edit field ${key}`);\n        }\n      }\n    });\n  }\n}\n"],"sourceRoot":""}